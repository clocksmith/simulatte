<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AEH - Adversarial Equity Heuristics</title>
    <link rel="stylesheet" href="../simulatte-core.css">
    <style>
      /* HEA-specific variables */
      :root {
        --win-color: var(--accent-secondary);   /* Green for wins */
        --loss-color: var(--accent-primary);    /* Magenta for losses */
        --tie-color: var(--accent-tertiary);    /* Cyan for ties */
      }
      body {
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .container {
        width: 100%;
        max-width: 1400px;
        display: grid;
        grid-template-columns: 450px 1fr;
        gap: 20px;
      }
      .panel {
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      h1 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 8px;
        margin-top: 0;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      h2,
      h3 {
        color: var(--primary-text);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
        margin-top: 0;
        font-weight: 400;
      }
      p,
      label {
        color: var(--secondary-text);
        line-height: 1.6;
      }
      .info-box {
        background-color: rgba(68, 1, 84, 0.2);
        border-left: 3px solid #440154;
        padding: 10px 15px;
        margin: 15px 0;
        border-radius: 4px;
      }

      /* LEFT PANEL */
      .controls {
        margin-bottom: 20px;
      }
      .slider-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      input[type="range"] {
        width: 100%;
        cursor: pointer;
      }
      #opponent-count-label {
        font-weight: bold;
        font-size: 1.2em;
        color: var(--highlight-color);
        min-width: 120px;
      }

      .heatmap-container {
        display: grid;
        grid-template-columns: repeat(13, 1fr);
        width: 100%;
        aspect-ratio: 1/1;
        gap: 1px;
        background-color: var(--border-color);
        border: 2px solid var(--border-color);
      }
      .heatmap-cell {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
        user-select: none;
        color: white;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
      }
      .heatmap-cell:hover {
        transform: scale(1.1);
        z-index: 10;
      }
      .heatmap-cell.selected {
        box-shadow: 0 0 0 3px var(--highlight-color) inset;
        transform: scale(1.05);
        z-index: 5;
      }

      /* RIGHT PANEL */
      .poker-table {
        position: relative;
        width: 100%;
        aspect-ratio: 1.6/1;
        border: 2px solid #2a2a2a;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .hand-display {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .card {
        width: 40px;
        height: 60px;
        border-radius: 5px;
        background-color: white;
        color: black;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        border: 1px solid #ccc;
        user-select: none;
        box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.4);
      }
      .card.red {
        color: #d32f2f;
      }
      .card.black {
        color: #000000;
      }
      .card-back {
        background: #212121;
        border: 1px solid #444;
        background-image: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 3px,
          rgba(255, 255, 255, 0.05) 3px,
          rgba(255, 255, 255, 0.05) 6px
        );
      }
      #board-cards-container {
        position: absolute;
      }
      #hero-hand-container {
        position: absolute;
        bottom: 8%;
        left: 50%;
        transform: translateX(-50%);
      }
      .opponent-position {
        position: absolute;
        transform: translate(-50%, -50%);
      }
      .opponent-position.winner .card:not(.card-back) {
        box-shadow: 0 0 0 3px var(--highlight-color);
      }
      #hero-hand-container.winner .card {
        box-shadow: 0 0 0 3px var(--highlight-color);
      }
      .card.winning-card {
        box-shadow: 0 0 0 4px gold !important;
        transform: scale(1.05);
      }
      .opponent-position.leader::after,
      #hero-hand-container.leader::after {
        content: "★";
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        color: gold;
      }
      .position-label {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: var(--secondary-text);
        white-space: nowrap;
      }

      .equity-display {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        text-align: center;
        margin-bottom: 15px;
        width: 100%;
      }
      .equity-box {
        background-color: #2a2a2a;
        padding: 10px;
        border-radius: 6px;
      }
      .equity-box h4 {
        margin: 0 0 5px 0;
        font-size: 0.9em;
        color: var(--secondary-text);
        border: none;
      }
      .equity-box .value {
        font-size: 1.5em;
        font-weight: bold;
        color: #55c667ff;
      }
      .equity-box .value.live {
        font-size: 1.8em;
        color: var(--highlight-color);
      }

      #interactive-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      .sim-button {
        background-color: #35b779;
        color: black;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
      }
      .sim-button:hover:not(:disabled) {
        background-color: #44c489;
      }
      .sim-button:disabled {
        background-color: #555;
        color: #888;
        cursor: not-allowed;
      }

      /* CHARTING STYLES */
      .charts-section {
        margin-top: 20px;
      }
      .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .chart-container {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 6px;
      }
      .chart-container h3 {
        margin: 0 0 10px 0;
        font-size: 1em;
        text-align: center;
      }
      .chart-container svg {
        width: 100%;
        height: 200px;
        display: block;
      }
      .chart-tooltip {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 100;
      }

      @media (max-width: 1200px) {
        .container {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 600px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }
        .poker-table {
          aspect-ratio: 1.2/1;
        }
        .opponent-position {
          transform: translate(-50%, -50%) scale(0.85);
        }
        .card {
          width: 32px;
          height: 48px;
          font-size: 14px;
        }
        #hero-hand-container {
          bottom: 2%;
        }
      }
    </style>
  </head>
  <body>
    <div style="text-align: center; margin-bottom: 20px">
      <h1>AEH - Adversarial Equity Heuristics</h1>
      <p>
        Explore pre-flop strategy and see how equity shifts post-flop with full
        showdown analysis.
      </p>
    </div>

    <div class="container">
      <!-- LEFT PANEL -->
      <div class="left-panel panel">
        <h2>1. Pre-Flop Strategy</h2>
        <div class="controls">
          <label for="opponent-slider">Number of Opponents:</label>
          <div class="slider-container">
            <input
              type="range"
              id="opponent-slider"
              min="1"
              max="9"
              value="8"
            />
            <span id="opponent-count-label">8 Opponents</span>
          </div>
        </div>
        <div id="heatmap" class="heatmap-container"></div>
        <div class="info-box">
          <p>
            Select a hand from the grid. Color shows absolute strength (Bright/Yellow =
            Strong, Teal = Medium, Dark Purple = Weak).
          </p>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="right-panel">
        <div class="panel">
          <h2>
            2. In-Game Analysis:
            <span id="selected-hand-title">No Hand Selected</span>
          </h2>
          <div class="equity-display">
            <div class="equity-box" title="Average win rate for this hand across all possible scenarios with this many opponents">
              <h4>Expected Win Rate (All Scenarios)</h4>
              <span class="value" id="theoretical-equity-val">--</span>
            </div>
            <div class="equity-box" id="live-equity-box" title="Win probability based on the specific cards dealt in this hand">
              <h4>Current Hand Win Probability</h4>
              <span class="value live" id="live-equity-val">--</span>
            </div>
          </div>
          <div class="info-box" id="equity-explainer" style="display: none;">
            <p>
              <strong>Current Hand Win Probability</strong> simulates all possible remaining cards to calculate your exact chance of winning with the specific cards that were dealt to all players in this hand.
            </p>
          </div>
          <div class="poker-table" id="poker-table-area">
            <div id="board-cards-container" class="hand-display"></div>
            <div id="hero-hand-container" class="hand-display"></div>
            <!-- Opponent hands will be added here dynamically -->
          </div>
          <div id="interactive-controls">
            <button id="start-interactive-btn" class="sim-button" disabled>
              Play This Hand
            </button>
            <button
              id="deal-street-btn"
              class="sim-button"
              style="display: none"
            >
              Deal Flop
            </button>
            <button
              id="reset-hand-btn"
              class="sim-button"
              style="display: none"
            >
              New Hand
            </button>
            <button
              id="toggle-cards-btn"
              class="sim-button"
              style="display: none"
            >
              Reveal Opponent Cards
            </button>
          </div>
        </div>

        <div class="panel">
          <h2>3. Performance & Showdown</h2>
          <div id="charts-sections">
            <div class="charts-section" id="preflop-charts-section">
              <h3>Pre-Flop Analysis (Long-Term)</h3>
              <div class="charts-grid" id="preflop-charts-grid"></div>
            </div>
            <div
              class="charts-section"
              id="live-charts-section"
              style="display: none"
            >
              <h3>Live Hand Analysis</h3>
              <div class="charts-grid" id="live-charts-grid"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="tooltip" class="chart-tooltip"></div>

    <script>
      // ===================================================================================
      //               DEFINITIVE HOLD'EM ANALYZER SCRIPT
      // ===================================================================================

      document.addEventListener("DOMContentLoaded", () => {
        // SECTION 1: DATA, CONSTANTS, & STATE
        const RANKS = "AKQJT98765432".split("");
        const SUITS = ["s", "h", "d", "c"];
        const HAND_RANKS_TXT = [
          "High Card",
          "Pair",
          "Two Pair",
          "3-of-a-Kind",
          "Straight",
          "Flush",
          "Full House",
          "4-of-a-Kind",
          "Straight Flush",
        ];
        const equityData = {
          AA: {
            1: 85.2,
            2: 73.5,
            3: 64.5,
            4: 57.2,
            5: 51.2,
            6: 46.2,
            7: 41.9,
            8: 38.3,
            9: 35.1,
          },
          KK: {
            1: 82.4,
            2: 69.1,
            3: 58.7,
            4: 50.8,
            5: 44.4,
            6: 39.2,
            7: 34.9,
            8: 31.3,
            9: 28.3,
          },
          QQ: {
            1: 79.9,
            2: 65.3,
            3: 54.4,
            4: 46.5,
            5: 39.9,
            6: 34.7,
            7: 30.5,
            8: 27.1,
            9: 24.3,
          },
          JJ: {
            1: 77.5,
            2: 61.6,
            3: 50.3,
            4: 42.3,
            5: 36,
            6: 30.8,
            7: 26.7,
            8: 23.5,
            9: 20.9,
          },
          TT: {
            1: 75,
            2: 58,
            3: 46.5,
            4: 38.4,
            5: 32.3,
            6: 27.4,
            7: 23.5,
            8: 20.5,
            9: 18,
          },
          99: {
            1: 72.1,
            2: 54.5,
            3: 42.8,
            4: 34.9,
            5: 29.1,
            6: 24.5,
            7: 20.8,
            8: 17.9,
            9: 15.6,
          },
          88: {
            1: 69.1,
            2: 50.9,
            3: 39.2,
            4: 31.6,
            5: 26,
            6: 21.7,
            7: 18.3,
            8: 15.6,
            9: 13.5,
          },
          77: {
            1: 66.2,
            2: 47.5,
            3: 35.8,
            4: 28.4,
            5: 23.2,
            6: 19.2,
            7: 16,
            8: 13.6,
            9: 11.6,
          },
          66: {
            1: 63.2,
            2: 44.1,
            3: 32.5,
            4: 25.4,
            5: 20.5,
            6: 16.8,
            7: 13.9,
            8: 11.6,
            9: 9.8,
          },
          55: {
            1: 60.1,
            2: 40.8,
            3: 29.4,
            4: 22.5,
            5: 17.9,
            6: 14.6,
            7: 12,
            8: 9.9,
            9: 8.2,
          },
          44: {
            1: 56.9,
            2: 37.4,
            3: 26.4,
            4: 19.8,
            5: 15.6,
            6: 12.6,
            7: 10.2,
            8: 8.3,
            9: 6.8,
          },
          33: {
            1: 53.7,
            2: 34.2,
            3: 23.6,
            4: 17.3,
            5: 13.4,
            6: 10.7,
            7: 8.6,
            8: 6.9,
            9: 5.6,
          },
          22: {
            1: 50.4,
            2: 31,
            3: 20.9,
            4: 14.9,
            5: 11.4,
            6: 9,
            7: 7.1,
            8: 5.7,
            9: 4.6,
          },
          AKs: {
            1: 67,
            2: 51.2,
            3: 41.2,
            4: 34.1,
            5: 28.9,
            6: 24.9,
            7: 21.7,
            8: 19.1,
            9: 17,
          },
          AQs: {
            1: 66.1,
            2: 49.8,
            3: 39.5,
            4: 32.3,
            5: 27.2,
            6: 23.2,
            7: 20.1,
            8: 17.6,
            9: 15.6,
          },
          AJs: {
            1: 65.2,
            2: 48.4,
            3: 38,
            4: 30.7,
            5: 25.6,
            6: 21.8,
            7: 18.8,
            8: 16.4,
            9: 14.5,
          },
          ATs: {
            1: 64.3,
            2: 47.1,
            3: 36.5,
            4: 29.2,
            5: 24.2,
            6: 20.4,
            7: 17.5,
            8: 15.2,
            9: 13.3,
          },
          A9s: {
            1: 62.5,
            2: 44.9,
            3: 34.4,
            4: 27.1,
            5: 22.2,
            6: 18.6,
            7: 15.8,
            8: 13.6,
            9: 11.9,
          },
          A8s: {
            1: 61.5,
            2: 43.7,
            3: 33.2,
            4: 26,
            5: 21.1,
            6: 17.6,
            7: 14.9,
            8: 12.8,
            9: 11.1,
          },
          A7s: {
            1: 60.4,
            2: 42.4,
            3: 31.9,
            4: 24.8,
            5: 20,
            6: 16.6,
            7: 14,
            8: 12,
            9: 10.4,
          },
          A6s: {
            1: 59.3,
            2: 41.2,
            3: 30.7,
            4: 23.6,
            5: 18.9,
            6: 15.6,
            7: 13.1,
            8: 11.2,
            9: 9.7,
          },
          A5s: {
            1: 59.7,
            2: 41.6,
            3: 31.3,
            4: 24.3,
            5: 19.6,
            6: 16.2,
            7: 13.7,
            8: 11.7,
            9: 10.2,
          },
          A4s: {
            1: 58.5,
            2: 40.4,
            3: 30.1,
            4: 23.1,
            5: 18.5,
            6: 15.2,
            7: 12.8,
            8: 10.9,
            9: 9.4,
          },
          A3s: {
            1: 57.4,
            2: 39.1,
            3: 28.8,
            4: 22,
            5: 17.4,
            6: 14.3,
            7: 12,
            8: 10.2,
            9: 8.8,
          },
          A2s: {
            1: 56.2,
            2: 37.9,
            3: 27.6,
            4: 21,
            5: 16.5,
            6: 13.4,
            7: 11.2,
            8: 9.5,
            9: 8.1,
          },
          KQs: {
            1: 63.4,
            2: 46.5,
            3: 36.2,
            4: 29,
            5: 24,
            6: 20.2,
            7: 17.3,
            8: 15,
            9: 13.2,
          },
          KJs: {
            1: 62.4,
            2: 45.1,
            3: 34.6,
            4: 27.4,
            5: 22.4,
            6: 18.8,
            7: 16,
            8: 13.8,
            9: 12.1,
          },
          KTs: {
            1: 61.5,
            2: 43.8,
            3: 33.3,
            4: 26.1,
            5: 21.3,
            6: 17.8,
            7: 15.1,
            8: 13,
            9: 11.3,
          },
          K9s: {
            1: 59.5,
            2: 41.5,
            3: 31.1,
            4: 24.1,
            5: 19.4,
            6: 16.1,
            7: 13.6,
            8: 11.6,
            9: 10,
          },
          K8s: {
            1: 58.4,
            2: 40.2,
            3: 29.9,
            4: 23,
            5: 18.4,
            6: 15.2,
            7: 12.7,
            8: 10.8,
            9: 9.3,
          },
          K7s: {
            1: 57.2,
            2: 38.9,
            3: 28.7,
            4: 21.9,
            5: 17.4,
            6: 14.3,
            7: 12,
            8: 10.2,
            9: 8.7,
          },
          K6s: {
            1: 55.9,
            2: 37.5,
            3: 27.4,
            4: 20.8,
            5: 16.5,
            6: 13.5,
            7: 11.3,
            8: 9.5,
            9: 8.1,
          },
          K5s: {
            1: 54.7,
            2: 36.3,
            3: 26.3,
            4: 19.8,
            5: 15.6,
            6: 12.7,
            7: 10.6,
            8: 8.9,
            9: 7.6,
          },
          K4s: {
            1: 53.4,
            2: 35,
            3: 25.1,
            4: 18.8,
            5: 14.7,
            6: 12,
            7: 9.9,
            8: 8.3,
            9: 7,
          },
          K3s: {
            1: 52.2,
            2: 33.7,
            3: 23.9,
            4: 17.8,
            5: 13.8,
            6: 11.2,
            7: 9.2,
            8: 7.7,
            9: 6.5,
          },
          K2s: {
            1: 51,
            2: 32.5,
            3: 22.8,
            4: 16.9,
            5: 13,
            6: 10.5,
            7: 8.6,
            8: 7.2,
            9: 6,
          },
          QJs: {
            1: 60.4,
            2: 43,
            3: 32.7,
            4: 25.6,
            5: 20.7,
            6: 17.3,
            7: 14.7,
            8: 12.6,
            9: 11,
          },
          QTs: {
            1: 59.4,
            2: 41.7,
            3: 31.4,
            4: 24.4,
            5: 19.6,
            6: 16.3,
            7: 13.8,
            8: 11.8,
            9: 10.3,
          },
          Q9s: {
            1: 57.4,
            2: 39.4,
            3: 29.2,
            4: 22.4,
            5: 17.9,
            6: 14.7,
            7: 12.4,
            8: 10.5,
            9: 9.1,
          },
          Q8s: {
            1: 56.1,
            2: 38,
            3: 27.8,
            4: 21.2,
            5: 16.8,
            6: 13.8,
            7: 11.5,
            8: 9.7,
            9: 8.3,
          },
          Q7s: {
            1: 54.7,
            2: 36.6,
            3: 26.5,
            4: 19.9,
            5: 15.7,
            6: 12.8,
            7: 10.7,
            8: 9,
            9: 7.6,
          },
          Q6s: {
            1: 53.4,
            2: 35.2,
            3: 25.3,
            4: 18.9,
            5: 14.8,
            6: 12,
            7: 10,
            8: 8.4,
            9: 7.1,
          },
          Q5s: {
            1: 52.1,
            2: 33.9,
            3: 24.2,
            4: 17.9,
            5: 13.9,
            6: 11.3,
            7: 9.3,
            8: 7.8,
            9: 6.6,
          },
          Q4s: {
            1: 50.8,
            2: 32.6,
            3: 23,
            4: 16.9,
            5: 13.1,
            6: 10.6,
            7: 8.7,
            8: 7.2,
            9: 6.1,
          },
          Q3s: {
            1: 49.6,
            2: 31.3,
            3: 21.8,
            4: 15.9,
            5: 12.3,
            6: 9.9,
            7: 8.1,
            8: 6.7,
            9: 5.6,
          },
          Q2s: {
            1: 48.4,
            2: 30.1,
            3: 20.8,
            4: 15.1,
            5: 11.6,
            6: 9.3,
            7: 7.6,
            8: 6.3,
            9: 5.3,
          },
          JTs: {
            1: 57.3,
            2: 40,
            3: 29.9,
            4: 23,
            5: 18.4,
            6: 15.2,
            7: 12.8,
            8: 11,
            9: 9.5,
          },
          J9s: {
            1: 55.2,
            2: 37.7,
            3: 27.7,
            4: 21,
            5: 16.6,
            6: 13.6,
            7: 11.4,
            8: 9.6,
            9: 8.2,
          },
          J8s: {
            1: 53.8,
            2: 36.2,
            3: 26.3,
            4: 19.7,
            5: 15.5,
            6: 12.6,
            7: 10.5,
            8: 8.8,
            9: 7.5,
          },
          J7s: {
            1: 52.3,
            2: 34.7,
            3: 24.9,
            4: 18.5,
            5: 14.4,
            6: 11.7,
            7: 9.7,
            8: 8.1,
            9: 6.8,
          },
          J6s: {
            1: 50.8,
            2: 33.3,
            3: 23.6,
            4: 17.4,
            5: 13.4,
            6: 10.8,
            7: 8.9,
            8: 7.4,
            9: 6.2,
          },
          J5s: {
            1: 49.4,
            2: 31.9,
            3: 22.3,
            4: 16.3,
            5: 12.5,
            6: 10.1,
            7: 8.3,
            8: 6.9,
            9: 5.7,
          },
          J4s: {
            1: 48,
            2: 30.6,
            3: 21.2,
            4: 15.3,
            5: 11.7,
            6: 9.4,
            7: 7.7,
            8: 6.4,
            9: 5.3,
          },
          J3s: {
            1: 46.7,
            2: 29.3,
            3: 20.1,
            4: 14.4,
            5: 11,
            6: 8.8,
            7: 7.2,
            8: 5.9,
            9: 4.9,
          },
          J2s: {
            1: 45.4,
            2: 28,
            3: 19,
            4: 13.6,
            5: 10.3,
            6: 8.2,
            7: 6.7,
            8: 5.5,
            9: 4.6,
          },
          T9s: {
            1: 54.2,
            2: 37,
            3: 27.2,
            4: 20.8,
            5: 16.5,
            6: 13.6,
            7: 11.4,
            8: 9.7,
            9: 8.4,
          },
          T8s: {
            1: 52,
            2: 34.9,
            3: 25.2,
            4: 18.9,
            5: 14.8,
            6: 12,
            7: 10,
            8: 8.4,
            9: 7.1,
          },
          T7s: {
            1: 50.5,
            2: 33.4,
            3: 23.8,
            4: 17.7,
            5: 13.7,
            6: 11,
            7: 9.1,
            8: 7.6,
            9: 6.4,
          },
          T6s: {
            1: 48.9,
            2: 31.8,
            3: 22.4,
            4: 16.5,
            5: 12.7,
            6: 10.2,
            7: 8.4,
            8: 6.9,
            9: 5.8,
          },
          "98s": {
            1: 51.3,
            2: 34.3,
            3: 24.8,
            4: 18.8,
            5: 14.8,
            6: 12.1,
            7: 10.1,
            8: 8.6,
            9: 7.3,
          },
          "97s": {
            1: 49.1,
            2: 32.2,
            3: 22.8,
            4: 17,
            5: 13.2,
            6: 10.7,
            7: 8.8,
            8: 7.4,
            9: 6.2,
          },
          "96s": {
            1: 47.4,
            2: 30.6,
            3: 21.4,
            4: 15.8,
            5: 12.2,
            6: 9.8,
            7: 8,
            8: 6.7,
            9: 5.6,
          },
          "87s": {
            1: 48.5,
            2: 31.7,
            3: 22.5,
            4: 16.9,
            5: 13.2,
            6: 10.7,
            8: 7.5,
            9: 6.4,
            7: 8.9,
          },
          "86s": {
            1: 46.2,
            2: 29.6,
            3: 20.6,
            4: 15.1,
            5: 11.7,
            6: 9.4,
            7: 7.7,
            8: 6.4,
            9: 5.4,
          },
          "76s": {
            1: 45.7,
            2: 29.2,
            3: 20.4,
            4: 15.1,
            5: 11.8,
            6: 9.5,
            7: 7.9,
            8: 6.6,
            9: 5.6,
          },
          "75s": {
            1: 43.5,
            2: 27.1,
            3: 18.6,
            4: 13.6,
            5: 10.5,
            6: 8.4,
            7: 6.9,
            8: 5.7,
            9: 4.8,
          },
          "65s": {
            1: 43.4,
            2: 27.2,
            3: 18.8,
            4: 13.8,
            5: 10.7,
            6: 8.6,
            7: 7.1,
            8: 5.9,
            9: 5,
          },
          "54s": {
            1: 42.2,
            2: 26.2,
            3: 18,
            4: 13.2,
            5: 10.2,
            6: 8.1,
            7: 6.7,
            8: 5.5,
            9: 4.6,
          },
          AKo: {
            1: 65,
            2: 48.6,
            3: 38.3,
            4: 31.1,
            5: 25.9,
            6: 22,
            7: 18.9,
            8: 16.4,
            9: 14.4,
          },
          AQo: {
            1: 64,
            2: 47.1,
            3: 36.5,
            4: 29.3,
            5: 24.2,
            6: 20.3,
            7: 17.3,
            8: 15,
            9: 13.1,
          },
          AJo: {
            1: 63.1,
            2: 45.7,
            3: 35,
            4: 27.8,
            5: 22.8,
            6: 19,
            7: 16.2,
            8: 14,
            9: 12.2,
          },
          ATo: {
            1: 62.1,
            2: 44.4,
            3: 33.6,
            4: 26.3,
            5: 21.4,
            6: 17.8,
            7: 15.1,
            8: 13,
            9: 11.3,
          },
          A9o: {
            1: 60.1,
            2: 42,
            3: 31.3,
            4: 24.2,
            5: 19.5,
            6: 16,
            7: 13.5,
            8: 11.5,
            9: 9.9,
          },
          A8o: {
            1: 59.1,
            2: 40.8,
            3: 30.1,
            4: 23.1,
            5: 18.4,
            6: 15.1,
            7: 12.6,
            8: 10.8,
            9: 9.3,
          },
          A7o: {
            1: 57.9,
            2: 39.4,
            3: 28.8,
            4: 21.9,
            5: 17.4,
            6: 14.2,
            7: 11.8,
            8: 10,
            9: 8.6,
          },
          A6o: {
            1: 56.7,
            2: 38.1,
            3: 27.5,
            4: 20.8,
            5: 16.4,
            6: 13.3,
            7: 11.1,
            8: 9.4,
            9: 8,
          },
          A5o: {
            1: 55.4,
            2: 36.8,
            3: 26.4,
            4: 19.8,
            5: 15.5,
            6: 12.6,
            7: 10.5,
            8: 8.8,
            9: 7.5,
          },
          A4o: {
            1: 54.2,
            2: 35.5,
            3: 25.2,
            4: 18.8,
            5: 14.7,
            6: 11.9,
            7: 9.8,
            8: 8.2,
            9: 7,
          },
          A3o: {
            1: 53,
            2: 34.2,
            3: 24.1,
            4: 17.8,
            5: 13.8,
            6: 11.1,
            7: 9.2,
            8: 7.7,
            9: 6.5,
          },
          A2o: {
            1: 51.8,
            2: 32.9,
            3: 22.9,
            4: 16.8,
            5: 13,
            6: 10.4,
            7: 8.6,
            8: 7.2,
            9: 6.1,
          },
          KQo: {
            1: 61.2,
            2: 43.6,
            3: 33.2,
            4: 26.1,
            5: 21.2,
            6: 17.6,
            7: 14.9,
            8: 12.8,
            9: 11.1,
          },
          KJo: {
            1: 60.1,
            2: 42.2,
            3: 31.7,
            4: 24.6,
            5: 19.8,
            6: 16.4,
            7: 13.8,
            8: 11.8,
            9: 10.2,
          },
          KTo: {
            1: 59.1,
            2: 40.8,
            3: 30.3,
            4: 23.3,
            5: 18.6,
            6: 15.3,
            7: 12.8,
            8: 11,
            9: 9.5,
          },
          K9o: {
            1: 56.9,
            2: 38.4,
            3: 28.1,
            4: 21.3,
            5: 16.8,
            6: 13.7,
            7: 11.3,
            8: 9.6,
            9: 8.2,
          },
          K8o: {
            1: 55.7,
            2: 37,
            3: 26.8,
            4: 20.1,
            5: 15.8,
            6: 12.8,
            7: 10.5,
            8: 8.9,
            9: 7.6,
          },
          K7o: {
            1: 54.5,
            2: 35.7,
            3: 25.6,
            4: 19.1,
            5: 14.8,
            6: 11.9,
            7: 9.8,
            8: 8.2,
            9: 7,
          },
          K6o: {
            1: 53.1,
            2: 34.2,
            3: 24.2,
            4: 17.9,
            5: 13.8,
            6: 11.1,
            7: 9.1,
            8: 7.6,
            9: 6.4,
          },
          K5o: {
            1: 51.7,
            2: 32.8,
            3: 22.9,
            4: 16.8,
            5: 12.8,
            6: 10.3,
            7: 8.4,
            8: 7,
            9: 5.9,
          },
          K4o: {
            1: 50.3,
            2: 31.4,
            3: 21.7,
            4: 15.8,
            5: 11.9,
            6: 9.5,
            7: 7.8,
            8: 6.4,
            9: 5.4,
          },
          K3o: {
            1: 48.9,
            2: 30,
            3: 20.5,
            4: 14.8,
            5: 11.1,
            6: 8.8,
            7: 7.2,
            8: 5.9,
            9: 4.9,
          },
          K2o: {
            1: 47.6,
            2: 28.7,
            3: 19.4,
            4: 13.8,
            5: 10.3,
            6: 8.2,
            7: 6.6,
            8: 5.4,
            9: 4.5,
          },
          QJo: {
            1: 58,
            2: 40,
            3: 29.8,
            4: 22.8,
            5: 18.2,
            6: 15,
            7: 12.6,
            8: 10.7,
            9: 9.3,
          },
          QTo: {
            1: 56.9,
            2: 38.6,
            3: 28.5,
            4: 21.6,
            5: 17.1,
            6: 14,
            7: 11.7,
            8: 9.9,
            9: 8.5,
          },
          Q9o: {
            1: 54.7,
            2: 36.2,
            3: 26.2,
            4: 19.5,
            5: 15.2,
            6: 12.3,
            7: 10.1,
            8: 8.5,
            9: 7.2,
          },
          Q8o: {
            1: 53.3,
            2: 34.7,
            3: 24.8,
            4: 18.3,
            5: 14.2,
            6: 11.4,
            7: 9.4,
            8: 7.8,
            9: 6.6,
          },
          Q7o: {
            1: 51.9,
            2: 33.2,
            3: 23.5,
            4: 17.2,
            5: 13.2,
            6: 10.6,
            7: 8.7,
            8: 7.2,
            9: 6,
          },
          Q6o: {
            1: 50.5,
            2: 31.8,
            3: 22.2,
            4: 16.1,
            5: 12.3,
            6: 9.8,
            7: 8,
            8: 6.6,
            9: 5.5,
          },
          Q5o: {
            1: 49,
            2: 30.4,
            3: 21,
            4: 15.1,
            5: 11.5,
            6: 9.1,
            7: 7.4,
            8: 6.1,
            9: 5.1,
          },
          Q4o: {
            1: 47.6,
            2: 29,
            3: 19.8,
            4: 14.1,
            5: 10.7,
            6: 8.4,
            7: 6.8,
            8: 5.6,
            9: 4.7,
          },
          Q3o: {
            1: 46.2,
            2: 27.6,
            3: 18.7,
            4: 13.2,
            5: 9.9,
            6: 7.8,
            7: 6.3,
            8: 5.2,
            9: 4.3,
          },
          Q2o: {
            1: 44.9,
            2: 26.3,
            3: 17.6,
            4: 12.4,
            5: 9.2,
            6: 7.2,
            7: 5.8,
            8: 4.8,
            9: 3.9,
          },
          JTo: {
            1: 54.8,
            2: 36.9,
            3: 27,
            4: 20.2,
            5: 15.9,
            6: 13,
            7: 10.8,
            8: 9.2,
            9: 7.9,
          },
          J9o: {
            1: 52.6,
            2: 34.5,
            3: 24.7,
            4: 18.2,
            5: 14.1,
            6: 11.4,
            7: 9.4,
            8: 7.9,
            9: 6.7,
          },
          J8o: {
            1: 51.1,
            2: 32.9,
            3: 23.3,
            4: 17,
            5: 13.1,
            6: 10.5,
            7: 8.6,
            8: 7.2,
            9: 6,
          },
          J7o: {
            1: 49.5,
            2: 31.4,
            3: 21.9,
            4: 15.8,
            5: 12.1,
            6: 9.6,
            7: 7.8,
            8: 6.5,
            9: 5.4,
          },
          T9o: {
            1: 51.5,
            2: 33.8,
            3: 24.3,
            4: 18,
            5: 14,
            6: 11.3,
            7: 9.4,
            8: 7.9,
            9: 6.7,
          },
          T8o: {
            1: 49.2,
            2: 31.6,
            3: 22.3,
            4: 16.3,
            5: 12.5,
            6: 10,
            7: 8.2,
            8: 6.8,
            9: 5.7,
          },
          "98o": {
            1: 48.4,
            2: 31,
            3: 21.9,
            4: 16.1,
            5: 12.4,
            6: 10,
            7: 8.2,
            8: 6.9,
            9: 5.8,
          },
          "97o": {
            1: 46.1,
            2: 28.9,
            3: 20,
            4: 14.5,
            5: 11.1,
            6: 8.8,
            7: 7.2,
            8: 6,
            9: 5,
          },
          "87o": {
            1: 45.4,
            2: 28.3,
            3: 19.6,
            4: 14.3,
            5: 11,
            6: 8.8,
            7: 7.2,
            8: 6,
            9: 5,
          },
          "86o": {
            1: 42.9,
            2: 26.1,
            3: 17.8,
            4: 12.8,
            5: 9.7,
            6: 7.7,
            7: 6.2,
            8: 5.1,
            9: 4.3,
          },
          "76o": {
            1: 42.4,
            2: 25.6,
            3: 17.5,
            4: 12.6,
            5: 9.6,
            6: 7.6,
            7: 6.2,
            8: 5.1,
            9: 4.3,
          },
          "72o": {
            1: 32.3,
            2: 19,
            3: 13.3,
            4: 9.7,
            5: 7.4,
            6: 5.9,
            7: 4.8,
            8: 4,
            9: 3.3,
          },
        };
        const VIRIDIS_PALETTE = [
          [0.267, 0.00487, 0.329],
          [0.282, 0.1, 0.422],
          [0.274, 0.199, 0.495],
          [0.247, 0.294, 0.542],
          [0.211, 0.387, 0.563],
          [0.174, 0.481, 0.561],
          [0.141, 0.573, 0.54],
          [0.122, 0.665, 0.506],
          [0.134, 0.755, 0.459],
          [0.208, 0.838, 0.389],
          [0.327, 0.914, 0.299],
          [0.48, 0.973, 0.207],
          [0.655, 1.012, 0.135],
          [0.84, 1.025, 0.106],
          [0.993, 1.009, 0.128],
        ];
        const appState = {
          numOpponents: 8,
          selectedHand: null,
          currentTheoretical: null,
          theoreticalCache: new Map(),
          currentDeal: null,
          latestLiveResult: null,
          showOpponentCards: false,
        };

        // SECTION 2: UI & UTILITIES
        function getViridisColor(t) {
          t = Math.max(0, Math.min(1, t));
          const i = Math.floor(t * (VIRIDIS_PALETTE.length - 1));
          const f = t * (VIRIDIS_PALETTE.length - 1) - i;
          const c1 = VIRIDIS_PALETTE[i];
          const c2 =
            VIRIDIS_PALETTE[Math.min(VIRIDIS_PALETTE.length - 1, i + 1)];
          const r = (c1[0] + (c2[0] - c1[0]) * f) * 255;
          const g = (c1[1] + (c2[1] - c1[1]) * f) * 255;
          const b = (c1[2] + (c2[2] - c1[2]) * f) * 255;
          return `rgb(${r},${g},${b})`;
        }
        function getEquityColor(equity) {
          const minEquity = 5;
          const maxEquity = 85;
          const normalized = (equity - minEquity) / (maxEquity - minEquity);
          return getViridisColor(normalized);
        }
        function renderHeatmap() {
          const heatmap = document.getElementById("heatmap");
          heatmap.innerHTML = "";
          RANKS.forEach((r1, i) => {
            RANKS.forEach((r2, j) => {
              const cell = document.createElement("div");
              cell.classList.add("heatmap-cell");
              let hand =
                i < j ? r1 + r2 + "s" : i > j ? r2 + r1 + "o" : r1 + r2;
              cell.textContent = hand.replace(/[so]/, "");
              cell.dataset.hand = hand;
              heatmap.appendChild(cell);
            });
          });
        }
        function updateHeatmapColors() {
          document.querySelectorAll(".heatmap-cell").forEach((cell) => {
            const equity =
              (equityData[cell.dataset.hand] &&
                equityData[cell.dataset.hand][appState.numOpponents]) ||
              0;
            cell.style.backgroundColor = getEquityColor(equity);
          });
        }
        function createCardElement(cardStr) {
          const cardDiv = document.createElement("div");
          if (!cardStr) {
            cardDiv.className = "card card-back";
            return cardDiv;
          }
          const rank = cardStr.slice(0, -1);
          const suit = cardStr.slice(-1);
          const suitSymbols = { s: "♠", h: "♥", d: "♦", c: "♣" };
          const colorClass = suit === "h" || suit === "d" ? "red" : "black";
          cardDiv.className = `card ${colorClass}`;
          cardDiv.innerHTML = `${rank}<br>${suitSymbols[suit]}`;
          return cardDiv;
        }
        function renderPokerTable(showdown = false, winners = [], winningHands = []) {
          const table = document.getElementById("poker-table-area");
          const heroDiv = document.getElementById("hero-hand-container");
          const boardDiv = document.getElementById("board-cards-container");
          if (!table || !heroDiv || !boardDiv) return;

          heroDiv.innerHTML = "";
          heroDiv.classList.remove("winner", "leader");
          boardDiv.innerHTML = "";
          table
            .querySelectorAll(".opponent-position")
            .forEach((el) => el.remove());

          if (!appState.currentDeal) {
            // Show static display before dealing
            const heroCards = appState.selectedHand
              ? displayHandFromString(appState.selectedHand)
              : [];
            heroCards.forEach((c) => heroDiv.appendChild(createCardElement(c)));

            const opponents = appState.numOpponents;
            const radius = 45;
            const angleStep = 360 / (opponents + 1);
            for (let i = 0; i < opponents; i++) {
              const angle = ((90 + (i + 1) * angleStep) * Math.PI) / 180;
              const x = 50 + radius * Math.cos(angle);
              const y = 50 + radius * Math.sin(angle) * 0.75;
              const oppDiv = document.createElement("div");
              oppDiv.className = "opponent-position hand-display";
              oppDiv.style.left = `${x}%`;
              oppDiv.style.top = `${y}%`;
              oppDiv.appendChild(createCardElement(null));
              oppDiv.appendChild(createCardElement(null));
              table.appendChild(oppDiv);
            }
            return;
          }

          // Show live dealt cards
          const { heroHand, opponentHands, board, street } = appState.currentDeal;
          const showCards = showdown || appState.showOpponentCards;

          heroHand.forEach((c) => {
            const card = createCardElement(c);
            if (winningHands[0] && winningHands[0].includes(c)) {
              card.classList.add("winning-card");
            }
            heroDiv.appendChild(card);
          });
          heroDiv.classList.toggle("winner", winners.includes(0));

          const radius = 45;
          const angleStep = 360 / (appState.numOpponents + 1);
          opponentHands.forEach((hand, i) => {
            const angle = ((90 + (i + 1) * angleStep) * Math.PI) / 180;
            const x = 50 + radius * Math.cos(angle);
            const y = 50 + radius * Math.sin(angle) * 0.75;
            const oppDiv = document.createElement("div");
            oppDiv.className = "opponent-position hand-display";
            oppDiv.style.left = `${x}%`;
            oppDiv.style.top = `${y}%`;

            const card1 = createCardElement(showCards ? hand[0] : null);
            const card2 = createCardElement(showCards ? hand[1] : null);
            const playerIndex = i + 1;
            if (winningHands[playerIndex] && showCards) {
              if (winningHands[playerIndex].includes(hand[0])) card1.classList.add("winning-card");
              if (winningHands[playerIndex].includes(hand[1])) card2.classList.add("winning-card");
            }
            oppDiv.appendChild(card1);
            oppDiv.appendChild(card2);
            oppDiv.classList.toggle("winner", winners.includes(playerIndex));

            const label = document.createElement("div");
            label.className = "position-label";
            label.textContent = `Opp ${i + 1}`;
            oppDiv.appendChild(label);

            table.appendChild(oppDiv);
          });

          const boardCards =
            street === "preflop"
              ? []
              : board.slice(
                  0,
                  street === "flop" ? 3 : street === "turn" ? 4 : 5
                );
          boardCards.forEach((c) => {
            const card = createCardElement(c);
            // Check if this board card is part of any winning hand
            if (showdown && winningHands.some(wh => wh && wh.includes(c))) {
              card.classList.add("winning-card");
            }
            boardDiv.appendChild(card);
          });
        }

        function displayHandFromString(handStr) {
          if (!handStr || handStr.length < 2) return [];
          const r1 = handStr[0];
          const r2 = handStr[1];
          if (handStr.length === 2) {
            return [r1 + "s", r1 + "h"];
          }
          if (handStr[2] === "s") {
            return [r1 + "s", r2 + "s"];
          }
          return [r1 + "s", r2 + "h"];
        }
        function resetUIForNewSelection() {
          document.getElementById("selected-hand-title").textContent =
            appState.selectedHand || "No Hand Selected";
          appState.currentTheoretical = null;
          appState.latestLiveResult = null;
          appState.currentDeal = null;
          appState.showOpponentCards = false;
          updateEquityDisplay(null, null);
          document.getElementById("preflop-charts-grid").innerHTML =
            '<div class="info-box" style="grid-column: 1 / -1; text-align: center;"><p>Select a hand to see its analysis.</p></div>';
          document.getElementById("live-charts-section").style.display = "none";
          document.getElementById("equity-explainer").style.display = "none";
          document.getElementById("start-interactive-btn").disabled = !appState.selectedHand;
          document.getElementById("start-interactive-btn").style.display = "inline-block";
          document.getElementById("deal-street-btn").style.display = "none";
          document.getElementById("reset-hand-btn").style.display = "none";
          document.getElementById("toggle-cards-btn").style.display = "none";
          renderPokerTable();
        }
        function updateEquityDisplay(theoretical, live) {
          const theoreticalEl = document.getElementById(
            "theoretical-equity-val"
          );
          const liveEl = document.getElementById("live-equity-val");

          if (theoreticalEl) {
            if (theoretical && typeof theoretical.equity === "number") {
              theoreticalEl.textContent = `${theoretical.equity.toFixed(1)}%`;
              if (theoretical.samples) {
                theoreticalEl.title = `Precomputed table value`;
              } else {
                theoreticalEl.removeAttribute("title");
              }
            } else {
              theoreticalEl.textContent = "--";
              theoreticalEl.removeAttribute("title");
            }
          }

          if (liveEl) {
            if (live && typeof live.equity === "number") {
              liveEl.textContent = `${live.equity.toFixed(1)}%`;
              liveEl.title = live.stderr ? `Std Err: ${live.stderr.toFixed(2)}%` : "";
            } else {
              liveEl.textContent = "--";
              liveEl.removeAttribute("title");
            }
          }
        }


        // SECTION 3: POKER LOGIC & SIMULATION
        function createDeck() {
          return SUITS.flatMap((s) => RANKS.map((r) => r + s));
        }
        function shuffleDeck(deck) {
          for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
          }
          return deck;
        }
        function handStringToCards(handStr) {
          const r1 = handStr[0],
            r2 = handStr[1];

          // For pairs, return same rank with different suits
          if (handStr.length === 2) {
            const suit1 = SUITS[Math.floor(Math.random() * SUITS.length)];
            const availableSuits = SUITS.filter(s => s !== suit1);
            const suit2 = availableSuits[Math.floor(Math.random() * availableSuits.length)];
            return [r1 + suit1, r1 + suit2];
          }

          // For suited hands, pick a random suit for both cards
          if (handStr[2] === "s") {
            const suit = SUITS[Math.floor(Math.random() * SUITS.length)];
            return [r1 + suit, r2 + suit];
          }

          // For offsuit hands, pick two different random suits
          const suit1 = SUITS[Math.floor(Math.random() * SUITS.length)];
          const availableSuits = SUITS.filter(s => s !== suit1);
          const suit2 = availableSuits[Math.floor(Math.random() * availableSuits.length)];
          return [r1 + suit1, r2 + suit2];
        }
        function evaluateHand(sevenCards) {
          const rankValues = "23456789TJQKA";
          const cardRanks = sevenCards
            .map((c) => rankValues.indexOf(c[0]))
            .sort((a, b) => b - a);
          const cardSuits = sevenCards.map((c) => c[1]);
          const rankCounts = cardRanks.reduce(
            (acc, r) => ((acc[r] = (acc[r] || 0) + 1), acc),
            {}
          );
          const suitCounts = cardSuits.reduce(
            (acc, s) => ((acc[s] = (acc[s] || 0) + 1), acc),
            {}
          );
          const isFlush = Object.values(suitCounts).some((c) => c >= 5);
          const flushSuit = isFlush
            ? Object.keys(suitCounts).find((s) => suitCounts[s] >= 5)
            : null;
          const flushRanks = isFlush
            ? sevenCards
                .filter((c) => c[1] === flushSuit)
                .map((c) => rankValues.indexOf(c[0]))
                .sort((a, b) => b - a)
            : [];
          const uniqueRanks = [...new Set(cardRanks)];
          let isStraight = false,
            straightHighRank = -1;
          if ([12, 3, 2, 1, 0].every((r) => uniqueRanks.includes(r))) {
            isStraight = true;
            straightHighRank = 3;
          } else {
            for (let i = 0; i <= uniqueRanks.length - 5; i++) {
              if (uniqueRanks[i] - uniqueRanks[i + 4] === 4) {
                isStraight = true;
                straightHighRank = uniqueRanks[i];
                break;
              }
            }
          }
          let isStraightFlush = false,
            sfHighRank = -1;
          if (isFlush) {
            const uniqueFlushRanks = [...new Set(flushRanks)];
            if ([12, 3, 2, 1, 0].every((r) => uniqueFlushRanks.includes(r))) {
              isStraightFlush = true;
              sfHighRank = 3;
            } else {
              for (let i = 0; i <= uniqueFlushRanks.length - 5; i++) {
                if (uniqueFlushRanks[i] - uniqueFlushRanks[i + 4] === 4) {
                  isStraightFlush = true;
                  sfHighRank = uniqueFlushRanks[i];
                  break;
                }
              }
            }
          }
          if (isStraightFlush) return [8, sfHighRank];
          const counts = Object.values(rankCounts).sort((a, b) => b - a);
          const rankKeys = Object.keys(rankCounts)
            .sort((a, b) => rankCounts[b] - rankCounts[a] || b - a)
            .map(Number);
          if (counts[0] === 4) return [7, rankKeys[0], rankKeys[1]];
          if (counts[0] === 3 && counts[1] >= 2)
            return [6, rankKeys[0], rankKeys[1]];
          if (isFlush) return [5, ...flushRanks.slice(0, 5)];
          if (isStraight) return [4, straightHighRank];
          if (counts[0] === 3) return [3, rankKeys[0], ...rankKeys.slice(1, 3)];
          if (counts[0] === 2 && counts[1] === 2)
            return [2, rankKeys[0], rankKeys[1], rankKeys[2]];
          if (counts[0] === 2) return [1, rankKeys[0], ...rankKeys.slice(1, 4)];
          return [0, ...cardRanks.slice(0, 5)];
        }
        function compareScores(sA, sB) {
          for (let i = 0; i < sA.length; i++) {
            if (sA[i] > sB[i]) return 1;
            if (sA[i] < sB[i]) return -1;
          }
          return 0;
        }

        function computeEquityForDeal(heroHand, opponentHands, boardCards) {
          const deck = createDeck().filter(
            c => !heroHand.includes(c) && !opponentHands.flat().includes(c) && !boardCards.includes(c)
          );

          const numSims = 1000;
          let wins = 0, ties = 0;
          const handDistribution = new Array(9).fill(0);

          for (let sim = 0; sim < numSims; sim++) {
            const shuffled = shuffleDeck([...deck]);
            const fullBoard = [...boardCards];
            while (fullBoard.length < 5) {
              fullBoard.push(shuffled.pop());
            }

            const heroScore = evaluateHand([...heroHand, ...fullBoard]);
            handDistribution[heroScore[0]]++;

            const oppScores = opponentHands.map(hand => evaluateHand([...hand, ...fullBoard]));
            let heroWins = true;
            let isTie = false;

            for (const oppScore of oppScores) {
              const cmp = compareScores(heroScore, oppScore);
              if (cmp < 0) {
                heroWins = false;
                break;
              } else if (cmp === 0) {
                isTie = true;
              }
            }

            if (heroWins && isTie) {
              ties++;
            } else if (heroWins) {
              wins++;
            }
          }

          const equity = ((wins + ties * 0.5) / numSims) * 100;
          return {
            equity,
            samples: numSims,
            handDistribution,
          };
        }

        function startInteractiveHand() {
          if (!appState.selectedHand) return;

          const heroCards = handStringToCards(appState.selectedHand);
          const deck = shuffleDeck(
            createDeck().filter((c) => !heroCards.includes(c))
          );
          const opponentHands = Array.from(
            { length: appState.numOpponents },
            () => [deck.pop(), deck.pop()]
          );
          const board = Array.from({ length: 5 }, () => deck.pop());

          appState.currentDeal = {
            street: "preflop",
            deck,
            heroHand: heroCards,
            opponentHands,
            board,
          };

          document.getElementById("start-interactive-btn").style.display = "none";
          const dealBtn = document.getElementById("deal-street-btn");
          dealBtn.style.display = "inline-block";
          dealBtn.textContent = "Deal Flop";
          dealBtn.disabled = false;
          document.getElementById("reset-hand-btn").style.display = "inline-block";
          document.getElementById("toggle-cards-btn").style.display = "inline-block";
          document.getElementById("live-charts-section").style.display = "block";
          document.getElementById("equity-explainer").style.display = "block";

          updateLiveAnalysis();
        }

        function dealNextStreet() {
          if (!appState.currentDeal) return;
          const dealBtn = document.getElementById("deal-street-btn");
          dealBtn.disabled = true;

          const streets = ["preflop", "flop", "turn", "river"];
          const currentIdx = streets.indexOf(appState.currentDeal.street);
          if (currentIdx < streets.length - 1) {
            appState.currentDeal.street = streets[currentIdx + 1];
          }

          updateLiveAnalysis();
          const nextIdx = streets.indexOf(appState.currentDeal.street) + 1;
          if (nextIdx < streets.length) {
            dealBtn.textContent = `Deal ${
              streets[nextIdx].charAt(0).toUpperCase() + streets[nextIdx].slice(1)
            }`;
            dealBtn.disabled = false;
          } else {
            dealBtn.textContent = "Showdown!";
            handleShowdown();
          }
        }

        function updateLiveAnalysis() {
          renderPokerTable();
          const { heroHand, opponentHands, board, street } = appState.currentDeal;
          const boardCards =
            street === "preflop"
              ? []
              : board.slice(
                  0,
                  street === "flop" ? 3 : street === "turn" ? 4 : 5
                );

          const result = computeEquityForDeal(heroHand, opponentHands, boardCards);
          appState.latestLiveResult = result;
          updateEquityDisplay(appState.currentTheoretical, result);

          const liveChartsGrid = document.getElementById("live-charts-grid");
          liveChartsGrid.innerHTML =
            '<div class="chart-container" id="live-dist-chart"></div>';
          createDistributionBarChart(
            document.getElementById("live-dist-chart"),
            "Final Hand Strength %",
            result.handDistribution.map((count, i) => ({
              label: HAND_RANKS_TXT[i],
              value: count / result.samples,
            }))
          );
        }

        function handleShowdown() {
          const { heroHand, opponentHands, board } = appState.currentDeal;
          const allHands = [heroHand, ...opponentHands];
          const allScores = allHands.map((h) => evaluateHand([...h, ...board]));
          let bestScore = [-1];
          allScores.forEach((score) => {
            if (compareScores(score, bestScore) > 0) bestScore = score;
          });
          const winners = [];
          allScores.forEach((score, i) => {
            if (compareScores(score, bestScore) === 0) winners.push(i);
          });

          // Identify winning cards for each player
          const winningHands = allHands.map((hand, i) => {
            if (!winners.includes(i)) return null;
            return identifyWinningCards([...hand, ...board]);
          });

          renderPokerTable(true, winners, winningHands);

          const allPlayerEquities = allHands.map((_, i) => ({
            label: i === 0 ? "Hero" : `Opp. ${i}`,
            percent: winners.includes(i) ? 1 / winners.length : 0,
          }));

          const liveChartsGrid = document.getElementById("live-charts-grid");
          liveChartsGrid.innerHTML +=
            '<div class="chart-container" id="showdown-pie-chart"></div>';
          createPieChart(
            document.getElementById("showdown-pie-chart"),
            "Showdown Results (All Hands Known)",
            allPlayerEquities
          );
        }

        function identifyWinningCards(sevenCards) {
          const score = evaluateHand(sevenCards);
          const handType = score[0];
          const rankValues = "23456789TJQKA";

          // Return the 5 cards that make the winning hand
          if (handType === 8 || handType === 4) { // Straight Flush or Straight
            const highRank = score[1];
            if (highRank === 3) { // Wheel (A-2-3-4-5)
              return sevenCards.filter(c => [12, 0, 1, 2, 3].includes(rankValues.indexOf(c[0])));
            }
            return sevenCards.filter(c => {
              const r = rankValues.indexOf(c[0]);
              return r <= highRank && r >= highRank - 4;
            }).slice(0, 5);
          }

          if (handType === 7) { // Quads
            const quadRank = score[1];
            return sevenCards.filter(c => rankValues.indexOf(c[0]) === quadRank ||
                                          rankValues.indexOf(c[0]) === score[2]).slice(0, 5);
          }

          if (handType === 6) { // Full House
            return sevenCards.filter(c => [score[1], score[2]].includes(rankValues.indexOf(c[0]))).slice(0, 5);
          }

          if (handType === 5) { // Flush
            const suits = sevenCards.map(c => c[1]);
            const flushSuit = Object.entries(suits.reduce((acc, s) => ({...acc, [s]: (acc[s]||0)+1}), {}))
              .find(([s, count]) => count >= 5)?.[0];
            return sevenCards.filter(c => c[1] === flushSuit).slice(0, 5);
          }

          if (handType === 3) { // Three of a kind
            const tripRank = score[1];
            return sevenCards.filter(c => rankValues.indexOf(c[0]) === tripRank ||
                                          [score[2], score[3]].includes(rankValues.indexOf(c[0]))).slice(0, 5);
          }

          if (handType === 2) { // Two Pair
            return sevenCards.filter(c => [score[1], score[2], score[3]].includes(rankValues.indexOf(c[0]))).slice(0, 5);
          }

          if (handType === 1) { // One Pair
            return sevenCards.filter(c => [score[1], score[2], score[3], score[4]].includes(rankValues.indexOf(c[0]))).slice(0, 5);
          }

          // High card
          return sevenCards.slice(0, 5);
        }

        // SECTION 4: CHARTING ENGINE
        const tooltip = document.getElementById("tooltip");
        function showTooltip(evt, text) {
          tooltip.innerHTML = text;
          tooltip.style.opacity = "1";
          tooltip.style.left = `${evt.pageX + 10}px`;
          tooltip.style.top = `${evt.pageY + 10}px`;
        }
        function hideTooltip() {
          tooltip.style.opacity = "0";
        }
        function createLineChart(container, title, data, dataLabel) {
          container.innerHTML = `<h3>${title}</h3><svg viewBox="0 0 300 200"></svg>`;
          const svg = container.querySelector("svg");
          const points = data.map((d, i) => ({
            x: 30 + i * (260 / (data.length - 1)),
            y: 180 - d.y * 1.6,
          }));
          svg.innerHTML = `<line x1="30" y1="180" x2="290" y2="180" stroke="#777" /><line x1="30" y1="20" x2="30" y2="180" stroke="#777" /><text x="160" y="195" text-anchor="middle" font-size="10" fill="#aaa">Opponents</text><text x="15" y="100" transform="rotate(-90 15 100)" text-anchor="middle" font-size="10" fill="#aaa">Equity %</text>`;
          const path = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "path"
          );
          path.setAttribute(
            "d",
            "M" + points.map((p) => `${p.x} ${p.y}`).join(" L ")
          );
          path.setAttribute("fill", "none");
          path.setAttribute("stroke", "#35b779");
          path.setAttribute("stroke-width", "2");
          svg.appendChild(path);
          data.forEach((d, i) => {
            const circle = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "circle"
            );
            circle.setAttribute("cx", points[i].x);
            circle.setAttribute("cy", points[i].y);
            circle.setAttribute("r", "4");
            circle.setAttribute("fill", "#35b779");
            circle.addEventListener("mouseover", (evt) =>
              showTooltip(
                evt,
                `Vs ${d.x} Opps<br>${dataLabel}: ${d.y.toFixed(1)}%`
              )
            );
            circle.addEventListener("mouseout", hideTooltip);
            svg.appendChild(circle);
          });
        }
        function createPieChart(container, title, data) {
          container.innerHTML = `<h3>${title}</h3><svg viewBox="-1.1 -1.1 2.2 2.2" style="transform: rotate(-90deg)"></svg>`;
          const svg = container.querySelector("svg");
          let cumulativePercent = 0;
          data.forEach((slice, i) => {
            if (slice.percent === 0) return;
            const sliceColor =
              slice.color || getViridisColor(i / (data.length - 1));
            const [x1, y1] = [
              Math.cos(2 * Math.PI * cumulativePercent),
              Math.sin(2 * Math.PI * cumulativePercent),
            ];
            cumulativePercent += slice.percent;
            const [x2, y2] = [
              Math.cos(2 * Math.PI * cumulativePercent),
              Math.sin(2 * Math.PI * cumulativePercent),
            ];
            const path = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "path"
            );
            path.setAttribute(
              "d",
              `M ${x1} ${y1} A 1 1 0 ${
                slice.percent > 0.5 ? 1 : 0
              } 1 ${x2} ${y2} L 0 0`
            );
            path.setAttribute("fill", sliceColor);
            path.addEventListener("mouseover", (evt) =>
              showTooltip(
                evt,
                `${slice.label}: ${(slice.percent * 100).toFixed(1)}%`
              )
            );
            path.addEventListener("mouseout", hideTooltip);
            svg.appendChild(path);
          });
        }
        function createDistributionBarChart(container, title, data) {
          container.innerHTML = `<h3>${title}</h3><svg viewBox="0 0 300 200"></svg>`;
          const svg = container.querySelector("svg");
          const maxVal = Math.max(...data.map((d) => d.value));
          if (maxVal === 0) {
            svg.innerHTML = `<text x="150" y="100" text-anchor="middle" fill="#aaa">No Data</text>`;
            return;
          }
          const barWidth = 300 / data.length;
          data.forEach((d, i) => {
            if (d.value === 0) return;
            const barHeight = (d.value / maxVal) * 160;
            const rect = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "rect"
            );
            rect.setAttribute("x", i * barWidth + barWidth * 0.1);
            rect.setAttribute("y", 180 - barHeight);
            rect.setAttribute("width", barWidth * 0.8);
            rect.setAttribute("height", barHeight);
            rect.setAttribute("fill", getViridisColor(i / (data.length - 1)));
            rect.addEventListener("mouseover", (evt) =>
              showTooltip(
                evt,
                `${d.label}<br>Prob: ${(d.value * 100).toFixed(1)}%`
              )
            );
            rect.addEventListener("mouseout", hideTooltip);
            svg.appendChild(rect);
            const text = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text"
            );
            text.setAttribute("x", i * barWidth + barWidth / 2);
            text.setAttribute("y", 195);
            text.setAttribute("font-size", "8px");
            text.setAttribute("fill", "#aaa");
            text.setAttribute("text-anchor", "middle");
            text.textContent = d.label
              .replace("3-of-a-Kind", "Set")
              .replace("4-of-a-Kind", "Quads")
              .replace("Straight Flush", "Str. Flush")
              .split(" ")[0];
            svg.appendChild(text);
          });
        }

        // SECTION 5: EVENT HANDLERS & WORKFLOW
        function setupEventListeners() {
          document
            .getElementById("opponent-slider")
            .addEventListener("input", handleOpponentChange);
          document
            .getElementById("heatmap")
            .addEventListener("click", handleHeatmapClick);
          document
            .getElementById("start-interactive-btn")
            .addEventListener("click", startInteractiveHand);
          document
            .getElementById("deal-street-btn")
            .addEventListener("click", dealNextStreet);
          document
            .getElementById("reset-hand-btn")
            .addEventListener("click", () => {
              if (appState.selectedHand) {
                handleHandSelection(appState.selectedHand);
              }
            });
          document
            .getElementById("toggle-cards-btn")
            .addEventListener("click", toggleOpponentCards);
        }

        function toggleOpponentCards() {
          appState.showOpponentCards = !appState.showOpponentCards;
          const btn = document.getElementById("toggle-cards-btn");
          btn.textContent = appState.showOpponentCards
            ? "Hide Opponent Cards"
            : "Reveal Opponent Cards";
          renderPokerTable();
        }

        function handleOpponentChange(e) {
          appState.numOpponents = parseInt(e.target.value);
          document.getElementById("opponent-count-label").textContent = `${
            appState.numOpponents
          } Opponent${appState.numOpponents > 1 ? "s" : ""}`;
          updateHeatmapColors();
          if (appState.selectedHand) {
            handleHandSelection(appState.selectedHand);
          }
        }

        function handleHeatmapClick(e) {
          const cell = e.target.closest(".heatmap-cell");
          if (cell) {
            handleHandSelection(cell.dataset.hand);
          }
        }

        function handleHandSelection(hand) {
          appState.selectedHand = hand;
          resetUIForNewSelection();
          document
            .querySelectorAll(".heatmap-cell.selected")
            .forEach((c) => c.classList.remove("selected"));
          const selectedCell = document.querySelector(`.heatmap-cell[data-hand="${hand}"]`);
          if (selectedCell) selectedCell.classList.add("selected");

          const cacheKey = `${hand}|${appState.numOpponents}`;
          const tableEntry = equityData[hand] && equityData[hand][appState.numOpponents];
          const preflopChartsGrid = document.getElementById("preflop-charts-grid");
          preflopChartsGrid.innerHTML =
            '<div class="chart-container" id="line-chart-container"></div>';

          if (equityData[hand]) {
            createLineChart(
              document.getElementById("line-chart-container"),
              "Theoretical Equity vs. Opponents",
              Object.entries(equityData[hand]).map(([opps, eq]) => ({
                x: parseInt(opps, 10),
                y: eq,
              })),
              "Equity"
            );
          } else {
            document.getElementById("line-chart-container").innerHTML =
              '<div class="info-box"><p>No precomputed data available for this hand.</p></div>';
          }

          if (typeof tableEntry === "number") {
            const result = {
              equity: tableEntry,
              samples: null,
            };
            appState.theoreticalCache.set(cacheKey, result);
            appState.currentTheoretical = result;
            updateEquityDisplay(result, appState.latestLiveResult);
          } else {
            const cached = appState.theoreticalCache.get(cacheKey);
            if (cached) {
              appState.currentTheoretical = cached;
              updateEquityDisplay(cached, appState.latestLiveResult);
            } else {
              appState.currentTheoretical = null;
              updateEquityDisplay(null, appState.latestLiveResult);
            }
          }

          renderPokerTable();
        }

        // Initialize the application
        renderHeatmap();
        updateHeatmapColors();
        setupEventListeners();
        resetUIForNewSelection();
      });
    </script>
  </body>
</html>
